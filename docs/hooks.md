# Hooks

In this section, we cover the main mechanism for requesting data in `reason-urql` – hooks!

`reason-urql` comes with a set of custom hooks to use in your ReasonReact components, including `useQuery`, `useMutation`, `useDynamicMutation`, and `useSubscription`. These are fully type safe and will automatically infer the type of your GraphQL response if using `graphql_ppx_re` or `graphql_ppx`.

## `useQuery`

`useQuery` allows you to execute a GraphQL query.

### Arguments

| Argument        | Type                         | Description                                                                                                                                                                                                                                                             |
| --------------- | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `request`       | `Types.request`              | The `graphql_ppx` request representing your query. Generated by calling `.make()` on the `graphql_ppx` module. If you're not using `graphql_ppx`, pass a `Js.t` of the following shape: `{. "query": string, "variables": Js.Json.t, "parse": Js.Json.t => 'response }` |
| `requestPolicy` | `Types.requestPolicy=?`      | Optional. The request policy to use to execute the query. Defaults to `"cache-first"`.                                                                                                                                                                                  |
| `pause`         | `bool=?`                     | Optional. A boolean flag instructing `useQuery` to pause execution of the query operation.                                                                                                                                                                              |
| `fetchOptions`  | `Fetch.requestInit=?`        | Optional. The fetch options to apply on the outgoing request.                                                                                                                                                                                                           |
| `requestPolicy` | `Types.requestPolicy=?`      | Optional. The request policy to use to execute the query. Defaults to `"cache-first"`.                                                                                                                                                                                  |
| `pollInterval`  | `int=?`                      | Optional. Instructs the hook to reexecute the query every `pollInterval` milliseconds.                                                                                                                                                                                  |
| `url`           | `string=?`                   | Optional. The GraphQL endpoint to use for the executing operation (if different from the one specified by `Client.make`).                                                                                                                                               |
| `pollInterval`  | `int=?`                      | Optional. Instructs the client to reexecute the query every `pollInterval` milliseconds.                                                                                                                                                                                |
| `meta`          | `Types.operationDebugMeta=?` | Optional. Add metadata that is only available in development with devtools.                                                                                                                                                                                             |

### Return Type

`useQuery` returns a tuple containing the result of executing your GraphQL query and a function for re-executing the query imperatively.

| Return Value   | Type                                                                                                                                                                 | Description                                                                                                                                                                                                                                                          |
| -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `state`        | `Types.hookResponse('response)`                                                                                                                                      | A record containing fields for `fetching`, `data`, `error`, `response`, `extensions`, and `stale`. `response` is a variant containing constructors for `Data`, `PartialData`, `Error`, `Fetching` and `Empty`. Useful for pattern matching to render conditional UI. |
| `executeQuery` | `(~fetchOptions: Fetch.requestInit=?, ~requestPolicy: Types.requestPolicy=?, ~url: string=?, ~meta: Types.operationDebugMeta=?, ~pollInterval: int=?, unit) => unit` | A function for imperatively re-executing the query. Accepts labelled arguments for modifying specific conditions of the query execution.                                                                                                                             |

### Example

```reason
open ReasonUrql;

module GetPokémon = [%graphql
  {|
  query pokémon($name: String!) {
    pokemon(name: $name) {
      name
      classification
      image
    }
  }
|}
];

[@react.component]
let make = () => {
  let request = GetPokémon.make(~name="Butterfree", ());
  let (Hooks.{response}, executeQuery) = Hooks.useQuery(~request, ());

  switch (response) {
    | Fetching => <div> "Loading"->React.string </div>
    | Data(d) =>
      <div>
         <img src=d##pokemon##image>
         <span> d##pokemon##name->React.string </span>
         <span> d##pokemon##classification->React.string </span>
         <button
          onClick={_e =>
            executeQuery(
              ~requestPolicy=`NetworkOnly,
              ()
            )
          }
         >
          {j|Refetch data for $d##pokemon##name|j} -> React.string
         </button>
      </div>
    | Error(_e) => <div> "Error"->React.string </div>
    | Empty => <div> "Empty"->React.string </div>
  }
}
```

Check out `examples/2-query` to see an example of using the `useQuery` hook.

## `useMutation`

`useMutation` allows you to execute a GraphQL mutation via the returned `executeMutation` function.

### Arguments

| Argument  | Type            | Description                                                                                                                                                                                                                                                                |
| --------- | --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `request` | `Types.request` | The `graphql_ppx` request representing your mutation. Generated by calling `.make()` on the `graphql_ppx` module. If you're not using `graphql_ppx`, pass a `Js.t` of the following shape: `{. "query": string, "variables": Js.Json.t, "parse": Js.Json.t => 'response }` |

### Return Type

`useMutation` returns a tuple containing the result of executing your GraphQL mutation and a function for executing the mutation imperatively, `executeMutation`. By default, `useMutation` **does not** execute your mutation when your component renders – rather, it is up to you to call `executeMutation` when you want to by attaching it to on an event handler or running it inside of an effect. Read more on the [`urql` docs](https://formidable.com/open-source/urql/docs/basics/mutations/#sending-a-mutation).

| Return Value      | Type                                                                                                                                                                                                                                                                                                                                                       | Description                                                                                                                                                                                                                                                          |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `state`           | `Types.hookResponse('response)`                                                                                                                                                                                                                                                                                                                            | A record containing fields for `fetching`, `data`, `error`, `response`, `extensions`, and `stale`. `response` is a variant containing constructors for `Data`, `PartialData`, `Error`, `Fetching` and `Empty`. Useful for pattern matching to render conditional UI. |
| `executeMutation` | ``(~fetchOptions: Fetch.requestInit=?, ~requestPolicy: Types.requestPolicy=?, ~url: string=?, ~meta: Types.operationDebugMeta=?, ~pollInterval: int=?, unit) => Js.Promise.t(ClientTypes.operationResult)`| A function for imperatively re-executing the mutation. Accepts labelled arguments for modifying specific conditions of the mutation execution. |

### Example

```reason
open ReasonUrql;

module LikeDog = [%graphql
    {|
    mutation likeDog($key: ID!) {
      likeDog(key: $key) {
        likes
      }
    }
  |}
  ];

[@react.component]
let make = (~id) => {
  let request = LikeDog.make(~key=id, ());
  let (_, executeMutation) = Hooks.useMutation(~request);

  <button onClick={_e => executeMutation() |> ignore}>
    "Like This Dog!"->React.string
  </button>
}
```

Check out `examples/3-mutation` to see an example of using the `useMutation` hook.

## `useDynamicMutation`

`useDynamicMutation` is quite similar to `useMutation`, except it is a hook reserved for when you want to **dynamically** pass in variables to the `executeMutation` function _at execution time_. In contrast, `useMutation` applies variables immediately when the hook is called (_before executation time_).

A good example of a case where `useDynamicMutation` comes in handy is when you need to execute a mutation with variables retrieved from `useQuery` in the same component. See the Example section below for guidance on this technique.

### Arguments

| Argument     | Type                                                        | Description                                                                                           |
| ------------ | ----------------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| `definition` | `(Js.Json.t => 'response, string, Types.graphqlDefinition)` | The definition of your Graphql mutation. If using `graphql_ppx`, this is `MutationModule.definition`. |

### Return Type

`useDynamicMutation` returns nearly the same tuple as `useMutation`, containing the result of executing your GraphQL mutation and a function for executing the mutation imperatively. Unlike `useMutation`, the `executeMutation` function returned by `useDynamicMutation` accepts all your variables as named arguments, in addition to arguments for altering subsequent executions of the mutation.

| Return Value      | Type                                                                                                                                                                                                                             | Description                                                                                                                                                                                                                                                          |
| ----------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `state`           | `Types.hookResponse('response)`                                                                                                                                                                                                  | A record containing fields for `fetching`, `data`, `error`, `response`, `extensions`, and `stale`. `response` is a variant containing constructors for `Data`, `PartialData`, `Error`, `Fetching` and `Empty`. Useful for pattern matching to render conditional UI. |
| `executeMutation` | `(~myVar1, ~myVar2, ..., ~fetchOptions: Fetch.requestInit=?, ~requestPolicy: Types.requestPolicy=?, ~url: string=?, ~meta: Types.operationDebugMeta=?, ~pollInterval: int=?, unit) => Js.Promise.t(ClientTypes.operationResult)` | A function for imperatively executing the mutation, which accepts all the variables of your mutation as named arguments. Also accepts labelled arguments for modifying specific conditions of the mutation execution.                                                |

### Example

```reason
open ReasonUrql;

module GetAllDogs = [%graphql {|
  query dogs {
    dogs {
      name
      breed
      likes
    }
  }
|}];

module LikeDog = [%graphql
    {|
    mutation likeDog($key: ID!) {
      likeDog(key: $key) {
        likes
      }
    }
  |}
  ];

[@react.component]
let make = () => {
  let (Hooks.{ response }) = Hooks.useQuery(~request=GetAllDogs.make(), ());
  let (_, executeMutation) = Hooks.useDynamicMutation(LikeDog.definition);

  switch (response) {
    | Data(d) => {
      <button
      onClick={
        _e => executeMutation(
          ~key=d##dogs[0]##id,
          ~requestPolicy=`NetworkOnly,
          ),
        ()
      ) |> ignore}
      >
        "Like The First Dog!"->React.string
      </button>
    }
    | _ => React.null
  }
}
```

Check out `examples/3-mutation` to see an example of using the `useDynamicMutation` hook.

## `useSubscription`

`useSubscription` allows you to execute a GraphQL subscription. You can accumulate the results of executing subscriptions by passing a `handler` function to `useSubscription`.

If using the `useSubscription` hook, be sure your client is configured with the [`subscriptionExchange`](./exchanges#subscription-exchange).

### Arguments

| Argument        | Type                         | Description                                                                                                                                                                                                                                                                    |
| --------------- | ---------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `request`       | `Types.request`              | The `graphql_ppx` request representing your subscription. Generated by calling `.make()` on the `graphql_ppx` module. If you're not using `graphql_ppx`, pass a `Js.t` of the following shape: `{. "query": string, "variables": Js.Json.t, "parse": Js.Json.t => 'response }` |
| `handler`       | `Hooks.handler`              | Optional. A variant type to allow for proper type inference of accumulated subscription data. A `handler` function allows you to accumulate subscription responses in the `data` field of the returned state record.                                                           |
| `requestPolicy` | `Types.requestPolicy=?`      | Optional. The request policy to use to execute the query. Defaults to `"cache-first"`.                                                                                                                                                                                         |
| `pause`         | `bool=?`                     | Optional. A boolean flag instructing `useSubscription` to pause execution of the subscription.                                                                                                                                                                                 |
| `fetchOptions`  | `Fetch.requestInit=?`        | Optional. The fetch options to apply on the outgoing request.                                                                                                                                                                                                                  |
| `requestPolicy` | `Types.requestPolicy=?`      | Optional. The request policy to use to execute the query. Defaults to `"cache-first"`.                                                                                                                                                                                         |
| `pollInterval`  | `int=?`                      | Optional. Instructs the hook to reexecute the query every `pollInterval` milliseconds.                                                                                                                                                                                         |
| `url`           | `string=?`                   | Optional. The GraphQL endpoint to use for the executing operation (if different from the one specified by `Client.make`).                                                                                                                                                      |
| `pollInterval`  | `int=?`                      | Optional. Instructs the client to reexecute the subscription every `pollInterval` milliseconds.                                                                                                                                                                                |
| `meta`          | `Types.operationDebugMeta=?` | Optional. Add metadata that is only available in development with devtools.                                                                                                                                                                                                    |

### Return Type

`useSubscription` returns a tuple containing the result of executing your GraphQL subscription and a function for re-executing the subscription imperatively.

| Return Value          | Type                                                                                                                                                                 | Description                                                                                                                                                                                                                                                          |
| --------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `result`              | `Types.hookResponse('response)`                                                                                                                                      | A record containing fields for `fetching`, `data`, `error`, `response`, `extensions`, and `stale`. `response` is a variant containing constructors for `Data`, `PartialData`, `Error`, `Fetching` and `Empty`. Useful for pattern matching to render conditional UI. |
| `executeSubscription` | `(~fetchOptions: Fetch.requestInit=?, ~requestPolicy: Types.requestPolicy=?, ~url: string=?, ~meta: Types.operationDebugMeta=?, ~pollInterval: int=?, unit) => unit` | A function for imperatively re-executing the subscription. Accepts labelled arguments for modifying specific conditions of the subscription execution.                                                                                                               |

### Example

```reason
open ReasonUrql;

module SubscribeRandomInt = [%graphql
  {|
  subscription subscribeNumbers {
    newNumber @bsDecoder(fn: "string_of_int")
  }
|}
];

/* Accumulate subscriptions as new values arrive from your GraphQL endpoint. */
let handler = (prevSubscriptions, subscription) => {
  switch (prevSubscriptions) {
  | Some(subs) => Array.append(subs, [|subscription|])
  | None => [|subscription|]
  };
};

[@react.component]
let make = () => {
  let (Hooks.{response}) =
    Hooks.useSubscription(
      ~request=SubscribeRandomInt.make(),
      ~handler=Handler(handler)
    );

  switch (response) {
    | Fetching => <div> "Loading"->React.string </div>
    | Data(d) =>
      d
      |> Array.map(
      (datum) =>
        <circle
          cx=datum##newNumber
          cy=datum##newNumber
          stroke="#222"
          fill="none"
          r="5"
        />,
      )
      |> React.array
    | Error(_e) => <div> "Error"->React.string </div>
    | Empty => <div> "Empty"->React.string </div>
  }
}
```

Check out `examples/5-subscription` to see an example of using the `useSubscription` hook.

## `useClient`

`useClient` allows you to access your `urql` client instance anywhere within your React component tree.

### Return Type

| Return Value | Type       | Description                                      |
| ------------ | ---------- | ------------------------------------------------ |
| `client`     | `Client.t` | The `urql` client instance for your application. |

### Example

```reason
open ReasonUrql;

module GetAllDogs = [%graphql {|
  query dogs {
    dogs {
      name
      breed
      likes
    }
  }
|}];

[@react.component]
let make = () => {
  let client = Hooks.useClient();

  React.useEffect1(() => {
    let subscription = Client.executeQuery(~client, ~request=GetAllDogs.make(), ())
      |> Wonka.subscribe((. result) => Js.log(result));

    Some(subscription.unsubscribe);
  }, [|client|]);

  <div> "You can now use your client!"->React.string </div>
}
```
